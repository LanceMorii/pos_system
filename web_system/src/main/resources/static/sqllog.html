<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智慧超市系统 - SQL日志监控</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        /* 页面加载动画 */
        .page-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .page-loader.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        .loader-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;
            background: #f8fafc;
            color: #2c3e50;
            min-height: 100vh;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            color: #2c3e50;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            margin: 1rem;
        }

        .header h1 {
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .header-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .druid-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: #1e90ff;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 500;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .druid-link:hover {
            background: #1a7ee3;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(30, 144, 255, 0.4);
        }

        .btn {
            padding: 0.5rem 1rem;
            border: 1px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: #8b92ff;
            color: white;
            border-color: transparent;
        }

        .btn-primary:hover {
            background: #7980ff;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139, 146, 255, 0.4);
        }

        .btn-danger {
            background: #95a5a6;
            color: white;
            border-color: transparent;
        }

        .btn-danger:hover {
            background: #7f8c8d;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(149, 165, 166, 0.3);
        }

        .controls {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 1.25rem 1.5rem;
            border: 1px solid rgba(139, 146, 255, 0.1);
            border-radius: 12px 12px 0 0;
            box-shadow: 0 4px 16px rgba(139, 146, 255, 0.08);
            display: flex;
            gap: 1.25rem;
            align-items: center;
            flex-wrap: wrap;
            margin: 1rem 1rem 0 1rem;
            position: relative;
        }

        .controls::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, #8b92ff, transparent);
            border-radius: 12px 12px 0 0;
        }

        .search-box {
            flex: 1;
            min-width: 320px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 0.75rem 3rem 0.75rem 1.25rem;
            border: 2px solid rgba(139, 146, 255, 0.15);
            border-radius: 12px;
            font-size: 1rem;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            color: #2c3e50;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(139, 146, 255, 0.05);
        }

        .search-box input:focus {
            outline: none;
            border-color: #8b92ff;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 0 0 3px rgba(139, 146, 255, 0.15);
        }

        .search-box input::placeholder {
            color: #8892b0;
        }

        .search-box .search-icon {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #8b92ff;
            font-size: 1.1rem;
        }

        .filter-select {
            padding: 0.75rem 1rem;
            border: 2px solid rgba(139, 146, 255, 0.15);
            border-radius: 12px;
            font-size: 1rem;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            color: #2c3e50;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(139, 146, 255, 0.05);
            cursor: pointer;
            min-width: 140px;
        }

        .filter-select:focus {
            outline: none;
            border-color: #8b92ff;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 0 0 3px rgba(139, 146, 255, 0.15);
        }

        .stats {
            background: linear-gradient(135deg, #8b92ff 0%, #7980ff 100%);
            padding: 1.5rem;
            color: white;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 1rem;
            margin: 0 1rem;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(139, 146, 255, 0.12);
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.15);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.6s ease;
        }

        .stat-item:hover {
            transform: translateY(-3px);
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .stat-item:hover::before {
            left: 100%;
        }

        .stat-icon {
            font-size: 2rem;
            margin-bottom: 0.75rem;
            display: block;
        }

        .stat-value {
            font-weight: bold;
            font-size: 1.6rem;
            margin-bottom: 0.25rem;
            display: block;
        }

        .stat-label {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .main-content {
            padding: 0 1rem 2rem 1rem;
        }

        .sql-logs {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0 0 12px 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        .log-item {
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            padding: 1.5rem;
            transition: all 0.3s ease;
            position: relative;
        }

        .log-item:hover {
            background: rgba(139, 146, 255, 0.06);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .log-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: #8b92ff;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .log-item:hover::before {
            opacity: 1;
        }

        .log-item:last-child {
            border-bottom: none;
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .log-meta {
            display: flex;
            gap: 1rem;
            align-items: center;
            font-size: 0.9rem;
            color: #666;
        }

        .sql-type {
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .sql-type.SELECT {
            background: #e3f2fd;
            color: #1976d2;
        }

        .sql-type.INSERT {
            background: #e8f5e8;
            color: #388e3c;
        }

        .sql-type.UPDATE {
            background: #fff3e0;
            color: #f57c00;
        }

        .sql-type.DELETE {
            background: #ffebee;
            color: #d32f2f;
        }

        .performance {
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .performance.fast {
            background: #e8f5e8;
            color: #388e3c;
        }

        .performance.medium {
            background: #fff3e0;
            color: #f57c00;
        }

        .performance.slow {
            background: #ffebee;
            color: #d32f2f;
        }

        .log-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
            border: 1px solid #8b92ff;
            background: #8b92ff;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .btn-small:hover {
            background: #7980ff;
            border-color: #7980ff;
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(139, 146, 255, 0.4);
        }

        .btn-small:active {
            transform: translateY(0);
            box-shadow: 0 1px 4px rgba(139, 146, 255, 0.3);
        }

        .sql-content {
            background: linear-gradient(135deg, rgba(248, 249, 250, 0.9) 0%, rgba(233, 236, 239, 0.9) 100%);
            backdrop-filter: blur(10px);
            padding: 1.5rem;
            border-radius: 12px;
            font-family: 'Fira Code', 'Consolas', 'Monaco', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-all;
            margin-top: 1rem;
            border: 1px solid rgba(100, 108, 255, 0.2);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            position: relative;
        }

        .sql-content::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: #646cff;
            border-radius: 0 2px 2px 0;
        }

        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(139, 146, 255, 0.95) 0%, rgba(121, 128, 255, 0.95) 100%);
            backdrop-filter: blur(15px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            overflow: hidden;
        }

        .login-overlay::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: float 20s linear infinite;
            z-index: -1;
        }

        @keyframes float {
            0% {
                transform: translate(-50%, -50%) rotate(0deg);
            }

            100% {
                transform: translate(-50%, -50%) rotate(360deg);
            }
        }

        .login-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 2.5rem;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(255, 255, 255, 0.3);
            width: 100%;
            max-width: 420px;
            position: relative;
            overflow: hidden;
            animation: fadeInUp 0.6s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #8b92ff, #7980ff, #8b92ff);
            background-size: 200% 100%;
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {

            0%,
            100% {
                background-position: 200% 0;
            }

            50% {
                background-position: -200% 0;
            }
        }

        .login-header {
            text-align: center;
            margin-bottom: 2.5rem;
            position: relative;
            z-index: 1;
        }

        .login-header h2 {
            color: #2c3e50;
            font-size: 1.8rem;
            margin-bottom: 0.75rem;
            font-weight: 700;
            background: linear-gradient(135deg, #8b92ff 0%, #7980ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .login-header p {
            color: #64748b;
            font-size: 0.95rem;
            font-weight: 400;
            line-height: 1.5;
        }

        .form-group {
            margin-bottom: 1.5rem;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.75rem;
            color: #374151;
            font-weight: 600;
            font-size: 0.9rem;
            letter-spacing: 0.025em;
        }

        .form-group input {
            width: 100%;
            padding: 1rem 1.25rem;
            border: 2px solid rgba(139, 146, 255, 0.2);
            border-radius: 12px;
            font-size: 1rem;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            color: #2c3e50;
        }

        .form-group input:focus {
            outline: none;
            border-color: #8b92ff;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 0 0 4px rgba(139, 146, 255, 0.1);
            transform: translateY(-1px);
        }

        .form-group input::placeholder {
            color: #9ca3af;
        }

        .login-btn {
            width: 100%;
            padding: 1rem 1.5rem;
            background: linear-gradient(135deg, #8b92ff 0%, #7980ff 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.05rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(139, 146, 255, 0.3);
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(139, 146, 255, 0.4);
        }

        .error-message {
            color: #ef4444;
            text-align: center;
            margin-top: 1.5rem;
            display: none;
            background: rgba(239, 68, 68, 0.1);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            border: 1px solid rgba(239, 68, 68, 0.2);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #333;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            font-size: 0.9rem;
            max-width: 300px;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .toast.error {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .no-logs {
            text-align: center;
            padding: 3rem;
            color: #999;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #999;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .search-box {
                min-width: auto;
            }

            .stats {
                justify-content: center;
            }

            .log-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .log-meta {
                flex-wrap: wrap;
            }
        }
    </style>
</head>

<body>
    <!-- 页面加载器 -->
    <div class="page-loader" id="pageLoader">
        <div class="loader-spinner"></div>
    </div>

    <!-- 登录遮罩层 -->
    <div id="loginOverlay" class="login-overlay" style="display: none;">
        <div class="login-container">
            <div class="login-header">
                <h2>📊 SQL日志监控</h2>
                <p>请输入登录凭据以访问SQL日志监控面板</p>
                <p style="margin-top: 1rem; font-size: 0.85rem; color: #8b92ff;">默认账号密码：admin / admin</p>
            </div>

            <form id="loginForm">
                <div class="form-group">
                    <label for="username">👤 用户名</label>
                    <input type="text" id="username" name="username" placeholder="请输入用户名" value="admin" required>
                </div>

                <div class="form-group">
                    <label for="password">🔐 密码</label>
                    <input type="password" id="password" name="password" placeholder="请输入密码" value="admin" required>
                </div>

                <button type="submit" class="login-btn">登录</button>

                <div id="errorMessage" class="error-message">
                    用户名或密码错误
                </div>
            </form>
        </div>
    </div>

    <!-- 主页面内容 -->
    <div id="mainContent" style="display: none;">
        <div class="header">
            <h1>📊 智慧超市系统 - SQL日志监控</h1>
            <div class="header-actions">
                <a href="http://localhost:8080/druid/login.html" target="_blank" class="druid-link">📊 Druid监控</a>
                <button class="btn btn-primary" onclick="refreshLogs()">🔄 刷新</button>
                <button class="btn btn-primary" onclick="clearLogs()">🗑️ 清空日志</button>
                <button class="btn btn-primary" onclick="exportLogs()">📥 导出日志</button>
                <button class="btn btn-danger" onclick="logout()">🚪 退出</button>
            </div>
        </div>

        <div class="stats">
            <div class="stat-item">
                <div class="stat-icon">📊</div>
                <div class="stat-value" id="totalCount">0</div>
                <div class="stat-label">总记录数</div>
            </div>
            <div class="stat-item">
                <div class="stat-icon">⚡</div>
                <div class="stat-value" id="fastCount">0</div>
                <div class="stat-label">快速查询</div>
            </div>
            <div class="stat-item">
                <div class="stat-icon">⚠️</div>
                <div class="stat-value" id="mediumCount">0</div>
                <div class="stat-label">中等查询</div>
            </div>
            <div class="stat-item">
                <div class="stat-icon">🐌</div>
                <div class="stat-value" id="slowCount">0</div>
                <div class="stat-label">慢查询</div>
            </div>
        </div>

        <div class="controls">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="搜索SQL语句、表名或SQL类型..." oninput="filterLogs()">
                <span class="search-icon">🔍</span>
            </div>
            <select class="filter-select" id="typeFilter" onchange="filterLogs()">
                <option value="">所有类型</option>
                <option value="SELECT">SELECT</option>
                <option value="INSERT">INSERT</option>
                <option value="UPDATE">UPDATE</option>
                <option value="DELETE">DELETE</option>
            </select>
            <select class="filter-select" id="performanceFilter" onchange="filterLogs()">
                <option value="">所有性能</option>
                <option value="fast">快速 (&lt;500ms)</option>
                <option value="medium">中等 (500-1000ms)</option>
                <option value="slow">慢查询 (>1000ms)</option>
            </select>
        </div>

        <div class="main-content">
            <div class="sql-logs" id="sqlLogs">
                <div class="loading">
                    正在加载SQL日志...
                </div>
            </div>
        </div>
    </div>

    <script>
        let allLogs = [];
        let filteredLogs = [];
        let isAuthenticated = false;

        // 页面加载时检查认证状态
        document.addEventListener('DOMContentLoaded', function () {
            // 页面加载完成后隐藏加载器
            setTimeout(() => {
                const pageLoader = document.getElementById('pageLoader');
                pageLoader.classList.add('fade-out');
                setTimeout(() => {
                    pageLoader.style.display = 'none';
                }, 500);
            }, 1000);

            checkAuthStatus();
        });

        // 检查认证状态（静态验证）
        function checkAuthStatus() {
            const isLoggedIn = localStorage.getItem('sqlLogLogin') === 'true';
            if (isLoggedIn) {
                showMainContent();
            } else {
                showLoginOverlay();
            }
        }

        // 显示登录遮罩
        function showLoginOverlay() {
            document.getElementById('loginOverlay').style.display = 'flex';
            document.getElementById('mainContent').style.display = 'none';
            isAuthenticated = false;
        }

        // 显示主内容
        function showMainContent() {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            isAuthenticated = true;
            loadSqlLogs();
            // 每30秒自动刷新
            setInterval(loadSqlLogs, 30000);
        }

        // 登录表单提交
        document.getElementById('loginForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorMessage = document.getElementById('errorMessage');

            // 静态验证：默认账号密码为admin
            if (username === 'admin' && password === 'admin') {
                localStorage.setItem('sqlLogLogin', 'true');
                showMainContent();
                errorMessage.style.display = 'none';
                showToast('登录成功！', 'success');
            } else {
                errorMessage.style.display = 'block';
                errorMessage.textContent = '用户名或密码错误，请使用 admin / admin';
            }
        });

        // 加载SQL日志（从后端获取真实数据）
        async function loadSqlLogs() {
            if (!isAuthenticated) return;

            try {
                // 调用现有的logs API
                const response = await fetch('/api/sql-log/logs');
                const data = await response.json();

                if (data.success) {
                    allLogs = data.data.logs || [];
                    updateStats();
                    filterLogs();
                } else {
                    console.error('获取SQL日志失败:', data.message);
                    // 如果logs API不存在，尝试获取统计信息并显示提示
                    await updateStats();
                    document.getElementById('sqlLogs').innerHTML =
                        '<div class="no-logs">SQL日志监控功能正常运行<br/>统计信息已更新，请查看上方数据卡片</div>';
                }
            } catch (error) {
                console.error('加载SQL日志失败:', error);
                try {
                    // 尝试获取统计信息
                    await updateStats();
                    document.getElementById('sqlLogs').innerHTML =
                        '<div class="no-logs">SQL日志监控功能正常运行<br/>统计信息已更新，请查看上方数据卡片<br/><br/>💡 提示：执行数据库操作时，SQL日志会输出到后端控制台</div>';
                } catch (statsError) {
                    document.getElementById('sqlLogs').innerHTML =
                        '<div class="no-logs">无法连接到后端服务，请确保后端服务已启动</div>';
                }
            }
        }


        // 更新统计信息（从后端获取）
        async function updateStats() {
            try {
                const response = await fetch('/api/sql-log/stats');
                const data = await response.json();

                if (data.success) {
                    const stats = data.data;
                    document.getElementById('totalCount').textContent = stats.totalCount || 0;
                    document.getElementById('fastCount').textContent = stats.fastCount || 0;
                    document.getElementById('mediumCount').textContent = stats.mediumCount || 0;
                    document.getElementById('slowCount').textContent = stats.slowCount || 0;
                } else {
                    // 如果stats API返回失败，显示默认值
                    document.getElementById('totalCount').textContent = '0';
                    document.getElementById('fastCount').textContent = '0';
                    document.getElementById('mediumCount').textContent = '0';
                    document.getElementById('slowCount').textContent = '0';
                }
            } catch (error) {
                console.error('获取统计信息失败:', error);
                // 使用本地计算的统计信息作为备选
                const total = allLogs.length;
                const fast = allLogs.filter(log => log.executionTime < 500).length;
                const medium = allLogs.filter(log => log.executionTime >= 500 && log.executionTime < 1000).length;
                const slow = allLogs.filter(log => log.executionTime >= 1000).length;

                document.getElementById('totalCount').textContent = total;
                document.getElementById('fastCount').textContent = fast;
                document.getElementById('mediumCount').textContent = medium;
                document.getElementById('slowCount').textContent = slow;
            }
        }


        // 清空日志（调用后端API）
        async function clearLogs() {
            if (confirm('确定要清空所有SQL日志吗？')) {
                try {
                    // 由于后端没有clear API，这里只是清空前端显示
                    allLogs = [];
                    filteredLogs = [];
                    updateStats();
                    renderLogs();
                    showToast('前端日志显示已清空', 'success');
                } catch (error) {
                    console.error('清空失败:', error);
                    showToast('清空失败', 'error');
                }
            }
        }

        // 渲染日志列表（适配后端数据格式）
        function renderLogs() {
            const container = document.getElementById('sqlLogs');

            if (filteredLogs.length === 0) {
                container.innerHTML = '<div class="no-logs">暂无SQL日志记录</div>';
                return;
            }

            const html = filteredLogs.map(log => {
                const time = new Date(log.createdAt).toLocaleString();
                const performanceClass = getPerformanceClass(log.executionTime);
                const performanceText = getPerformanceText(log.executionTime);

                return `
                <div class="log-item">
                    <div class="log-header">
                        <div class="log-meta">
                            <span class="sql-type ${log.sqlType}">${log.sqlType}</span>
                            <span class="performance ${performanceClass}">${performanceText}</span>
                            <span>📅 ${time}</span>
                            ${log.tableName ? `<span>📋 ${log.tableName}</span>` : ''}
                            <span>📊 ${log.rowsAffected || 0} 行</span>
                            ${log.success === false ? '<span style="color: #dc3545;">❌ 失败</span>' : '<span style="color: #28a745;">✅ 成功</span>'}
                        </div>
                        <div class="log-actions">
                            <button class="btn-small" onclick="copySql(\`${log.sqlStatement.replace(/`/g, '\\`')}\`)">📋 复制</button>
                            <button class="btn-small" onclick="formatSql(\`${log.sqlStatement.replace(/`/g, '\\`')}\`)">🎨 格式化</button>
                            <button class="btn-small" onclick="analyzeSql(\`${log.sqlStatement.replace(/`/g, '\\`')}\`, ${log.executionTime})">🔍 分析</button>
                        </div>
                    </div>
                    <div class="sql-content">${escapeHtml(log.sqlStatement)}</div>
                    ${log.errorMessage ? `<div style="color: #dc3545; margin-top: 1rem; padding: 1rem; background: #f8d7da; border-radius: 8px;">错误信息: ${escapeHtml(log.errorMessage)}</div>` : ''}
                    <div id="result-${log.id}" class="sql-result" style="display: none;"></div>
                </div>
            `;
            }).join('');

            container.innerHTML = html;
        }

        // 过滤日志（适配后端数据格式）
        function filterLogs() {
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            const typeFilter = document.getElementById('typeFilter').value;
            const performanceFilter = document.getElementById('performanceFilter').value;

            filteredLogs = allLogs.filter(log => {
                // 搜索过滤
                const matchesSearch = !searchText ||
                    log.sqlStatement.toLowerCase().includes(searchText) ||
                    (log.tableName && log.tableName.toLowerCase().includes(searchText)) ||
                    log.sqlType.toLowerCase().includes(searchText);

                // 类型过滤
                const matchesType = !typeFilter || log.sqlType === typeFilter;

                // 性能过滤
                let matchesPerformance = true;
                if (performanceFilter === 'fast') {
                    matchesPerformance = log.executionTime < 500;
                } else if (performanceFilter === 'medium') {
                    matchesPerformance = log.executionTime >= 500 && log.executionTime < 1000;
                } else if (performanceFilter === 'slow') {
                    matchesPerformance = log.executionTime >= 1000;
                }

                return matchesSearch && matchesType && matchesPerformance;
            });

            renderLogs();
        }

        // 获取性能等级样式类
        function getPerformanceClass(elapsedTime) {
            if (elapsedTime < 500) return 'fast';
            if (elapsedTime < 1000) return 'medium';
            return 'slow';
        }

        // 获取性能等级文本
        function getPerformanceText(elapsedTime) {
            if (elapsedTime < 500) return `⚡ ${elapsedTime}ms`;
            if (elapsedTime < 1000) return `⚠️ ${elapsedTime}ms`;
            return `🐌 ${elapsedTime}ms`;
        }

        // 转义HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 复制SQL
        function copySql(sql) {
            navigator.clipboard.writeText(sql).then(() => {
                showToast('SQL已复制到剪贴板', 'success');
            }).catch(err => {
                console.error('复制失败:', err);
                showToast('复制失败', 'error');
            });
        }

        // 格式化SQL
        function formatSql(sql) {
            // 简单的SQL格式化
            const formatted = sql
                .replace(/\bSELECT\b/gi, '\nSELECT')
                .replace(/\bFROM\b/gi, '\nFROM')
                .replace(/\bWHERE\b/gi, '\nWHERE')
                .replace(/\bAND\b/gi, '\n  AND')
                .replace(/\bOR\b/gi, '\n  OR')
                .replace(/\bORDER BY\b/gi, '\nORDER BY')
                .replace(/\bGROUP BY\b/gi, '\nGROUP BY')
                .replace(/\bHAVING\b/gi, '\nHAVING')
                .replace(/\bLIMIT\b/gi, '\nLIMIT')
                .trim();

            navigator.clipboard.writeText(formatted).then(() => {
                showToast('格式化SQL已复制到剪贴板', 'success');
            }).catch(error => {
                console.error('复制失败:', error);
                showToast('复制失败', 'error');
            });
        }

        // 分析SQL
        function analyzeSql(sql, elapsedTime) {
            const analysis = {
                sql: sql,
                executionTime: elapsedTime,
                performance: elapsedTime < 500 ? '优秀' : elapsedTime < 1000 ? '良好' : '需要优化',
                suggestions: []
            };

            // 简单的SQL分析建议
            if (sql.includes('SELECT *')) {
                analysis.suggestions.push('建议避免使用 SELECT *，明确指定需要的字段');
            }
            if (!sql.includes('WHERE') && sql.includes('SELECT')) {
                analysis.suggestions.push('建议添加 WHERE 条件以提高查询效率');
            }
            if (elapsedTime > 1000) {
                analysis.suggestions.push('查询时间较长，建议检查索引或优化查询条件');
            }
            if (sql.includes('LEFT JOIN') || sql.includes('INNER JOIN')) {
                analysis.suggestions.push('使用了连接查询，确保连接字段有适当的索引');
            }

            showToast(`SQL分析完成 - 性能: ${analysis.performance}`, 'success');
            console.log('SQL分析结果:', analysis);
        }

        // 刷新日志
        function refreshLogs() {
            loadSqlLogs();
            showToast('日志已刷新', 'success');
        }

        // 导出日志
        function exportLogs() {
            if (filteredLogs.length === 0) {
                showToast('没有可导出的日志', 'error');
                return;
            }

            try {
                const csvContent = generateCsvContent(filteredLogs);
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `sql_logs_${new Date().getTime()}.csv`;
                link.click();
                showToast('日志已导出为CSV文件', 'success');
            } catch (error) {
                console.error('导出失败:', error);
                showToast('导出失败', 'error');
            }
        }

        // 生成CSV内容
        function generateCsvContent(logs) {
            const headers = ['时间', 'SQL类型', 'SQL语句', '表名', '执行时间(ms)', '影响行数', '状态'];
            let csvContent = headers.join(',') + '\n';

            logs.forEach(log => {
                const row = [
                    new Date(log.createdAt).toLocaleString(),
                    log.sqlType,
                    `"${log.sqlStatement.replace(/"/g, '""')}"`,
                    log.tableName || '',
                    log.executionTime,
                    log.rowsAffected || 0,
                    log.success === false ? '失败' : '成功'
                ];
                csvContent += row.join(',') + '\n';
            });

            return csvContent;
        }

        // 退出登录
        function logout() {
            if (confirm('确定要退出登录吗？')) {
                localStorage.removeItem('sqlLogLogin');
                showLoginOverlay();
                showToast('已退出登录', 'success');
            }
        }

        // 显示提示消息
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('show');
            }, 100);

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }
    </script>
</body>

</html>