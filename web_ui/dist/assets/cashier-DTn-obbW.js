import{d as pe,r as v,i as A,k as _e,c as r,b as s,e as a,y as o,w as n,f as ge,g as f,O as fe,U as I,P as ye,K as S,L as D,E as c,o as d,h as k,l as y,V as he,W as R,t as ee,X as se,Y as ke,Z as xe,D as Ce,A as we,_ as be}from"./index-DhDhwFZx.js";import{s as N}from"./request-Bb0hX5IM.js";function Ve(x){return N({url:"/cashier/products",method:"get",params:x})}function ze(x){return N({url:`/cashier/product/barcode/${x}`,method:"get"})}function Pe(x){return N({url:"/cashier/checkout",method:"post",data:x})}function qe(){return N({url:"/cashier/categories",method:"get"})}function Fe(){return N({url:"/cashier/health",method:"get"})}const Ue={class:"cashier-container"},Ae={class:"status-bar"},Ne={class:"store-info"},Be={class:"cashier-info"},Ie={class:"order-summary"},Se={class:"summary-item"},De={class:"value"},Ee={class:"summary-item"},$e={class:"value"},Me={class:"operation-section"},Te={class:"search-area"},Ke={class:"action-buttons"},Le={class:"main-content"},Oe={class:"products-section"},He={class:"section-header"},Qe={class:"category-filter"},We={class:"products-grid"},Xe=["onClick"],Ye={class:"product-image"},Ze=["src"],je={key:1,class:"product-placeholder"},Ge={class:"product-info"},Je={class:"product-name"},Re={class:"product-price"},es={class:"product-stock"},ss={key:0,class:"pagination-container"},ts={class:"cart-section"},ls={class:"section-header"},as={class:"cart-items"},os={key:0,class:"empty-cart"},ns={class:"item-info"},is={class:"item-name"},us={class:"item-price"},ds={class:"item-controls"},rs={class:"item-total"},cs={class:"cart-summary"},vs={class:"summary-row"},ms={class:"summary-row total"},ps={class:"checkout-dialog"},_s={class:"order-details"},gs={class:"order-items"},fs={class:"item-name"},ys={class:"item-price"},hs={class:"item-quantity"},ks={class:"item-subtotal"},xs={class:"amount-summary"},Cs={class:"summary-row"},ws={class:"summary-row"},bs={key:0,class:"summary-row"},Vs={class:"summary-row final-amount"},zs={class:"member-section"},Ps={class:"member-discount"},qs={class:"payment-section"},Fs={class:"payment-info"},Us={class:"payment-info"},As={class:"payment-info"},Ns={class:"payment-info"},Bs={key:0,class:"cash-payment"},Is={class:"cash-details"},Ss={class:"cash-row"},Ds={class:"amount"},Es={class:"cash-row"},$s={key:0,class:"cash-row"},Ms={class:"change-amount"},Ts={key:1,class:"electronic-payment"},Ks={class:"payment-info-box"},Ls={class:"payment-amount"},Os={class:"dialog-footer"},Hs=pe({__name:"cashier",setup(x){const E=v(!1),Q=v(""),te=v("收银员001"),C=v(""),$=v(null),B=v(1),M=v(12),w=v(0),b=v([]),F=v([]),i=v([]),U=v(!1),h=v("现金"),V=v(0),z=v(100),T=v(!1),K=A(()=>i.value.reduce((t,e)=>t+e.quantity,0)),P=A(()=>i.value.reduce((t,e)=>t+e.salePrice*e.quantity,0)),g=A(()=>P.value*(z.value/100)),W=A(()=>P.value-g.value),L=A(()=>h.value==="现金"?Math.max(0,V.value-g.value):0),X=()=>{Q.value=new Date().toLocaleString("zh-CN")},Y=async()=>{try{console.log("执行健康检查");const t=await Fe();console.log("健康检查响应:",t),t.code===200?(c.success("后端服务正常"),t.stats&&(console.log("数据统计:",t.stats),c.info(`商品数量: ${t.stats.productCount}, 分类数量: ${t.stats.categoryCount}`))):c.error("后端服务异常: "+t.message)}catch(t){console.error("健康检查失败:",t),c.error("无法连接到后端服务")}},le=async()=>{try{const t=await qe();t.code===200&&t.data?(F.value=t.data,console.log("加载分类成功:",F.value.length,"个分类")):(F.value=[],console.log("分类数据为空"))}catch(t){console.error("加载分类失败:",t),F.value=[]}},q=async()=>{E.value=!0;try{const t={page:B.value,size:M.value,name:C.value.trim()||void 0,categoryId:$.value||void 0};console.log("请求商品列表参数:",t);const e=await Ve(t);console.log("商品列表响应:",e),e.code===200&&e.data?e.data.content?(b.value=e.data.content,w.value=e.data.totalElements||0,console.log("加载商品成功:",b.value.length,"个商品")):(b.value=[],w.value=0,console.log("商品列表为空")):(b.value=[],w.value=0,c.error(e.message||"获取商品列表失败"))}catch(t){console.error("加载商品列表失败:",t),b.value=[],w.value=0,c.error("连接服务器失败")}finally{E.value=!1}},Z=async()=>{if(B.value=1,/^\d{8,}$/.test(C.value.trim()))try{const t=await ze(C.value);if(t.code===200&&t.data){j(t.data),C.value="";return}}catch{console.log("条码查询失败，尝试名称搜索")}q()},j=t=>{if(t.currentStock<=0){c.warning("商品库存不足");return}const e=i.value.find(m=>m.id===t.id);e?e.quantity<t.currentStock?(e.quantity++,c.success("商品数量已增加")):c.warning("库存不足"):(i.value.push({...t,quantity:1}),c.success("商品已添加到购物车"))},ae=t=>{if(t.quantity<=0){const e=i.value.findIndex(m=>m.id===t.id);e>-1&&i.value.splice(e,1)}},oe=t=>{i.value.splice(t,1),c.success("商品已移除")},ne=async()=>{if(i.value.length!==0)try{await we.confirm("确定要清空购物车吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),i.value=[],c.success("购物车已清空")}catch{}},ie=()=>{if(i.value.length===0){c.warning("购物车为空");return}h.value="现金",z.value=100,V.value=g.value,U.value=!0},ue=async()=>{var t,e,m;if(h.value==="现金"&&V.value<g.value){c.warning("收款金额不足");return}T.value=!0;try{const u={totalAmount:P.value,discountAmount:W.value,finalAmount:g.value,paymentMethod:h.value,receivedAmount:V.value,changeAmount:L.value,items:i.value.map(p=>({productId:p.id,productName:p.name,unitPrice:p.salePrice,quantity:p.quantity}))};console.log("提交结算数据:",u);const _=await Pe(u);console.log("结算响应:",_),_&&_.code===200?(c.success("结算成功！订单号: "+(((t=_.data)==null?void 0:t.orderNo)||"未知")),i.value=[],U.value=!1,q()):(console.error("结算失败，响应:",_),c.error((_==null?void 0:_.message)||"结算失败，请重试"))}catch(u){console.error("结算异常:",u),c.error("结算失败: "+(((m=(e=u==null?void 0:u.response)==null?void 0:e.data)==null?void 0:m.message)||(u==null?void 0:u.message)||"网络错误"))}finally{T.value=!1}},de=t=>{t.target.style.display="none";const e=document.createElement("div");e.className="product-placeholder",e.textContent="暂无图片",t.target.parentNode.appendChild(e)};return _e(async()=>{console.log("收银页面开始初始化"),X(),setInterval(X,1e3),await Y(),await le(),await q(),console.log("收银页面初始化完成")}),(t,e)=>{const m=f("el-icon"),u=f("el-button"),_=f("el-input"),p=f("el-radio"),G=f("el-radio-group"),re=f("el-pagination"),ce=f("el-empty"),O=f("el-input-number"),ve=f("el-dialog"),me=ye("loading");return d(),r("div",Ue,[s("div",Ae,[s("div",Ne,[e[9]||(e[9]=s("h2",null,"智慧超市系统 - 收银台",-1)),s("div",Be,[s("span",null,"收银员: "+o(te.value),1),s("span",null,"当前时间: "+o(Q.value),1)])]),s("div",Ie,[s("div",Se,[e[10]||(e[10]=s("span",{class:"label"},"商品数量:",-1)),s("span",De,o(K.value)+" 件",1)]),s("div",Ee,[e[11]||(e[11]=s("span",{class:"label"},"总金额:",-1)),s("span",$e,"¥"+o(P.value.toFixed(2)),1)])])]),s("div",Me,[s("div",Te,[a(_,{modelValue:C.value,"onUpdate:modelValue":e[0]||(e[0]=l=>C.value=l),placeholder:"输入商品名称或条码搜索",onKeyup:ge(Z,["enter"]),size:"large",clearable:""},{prefix:n(()=>[a(m,null,{default:n(()=>[a(y(he))]),_:1})]),append:n(()=>[a(u,{onClick:Z},{default:n(()=>e[12]||(e[12]=[k("搜索")])),_:1,__:[12]})]),_:1},8,["modelValue"])]),s("div",Ke,[a(u,{onClick:Y,size:"small"},{default:n(()=>e[13]||(e[13]=[k("健康检查")])),_:1,__:[13]}),a(u,{type:"danger",onClick:ne,disabled:i.value.length===0},{default:n(()=>[a(m,null,{default:n(()=>[a(y(R))]),_:1}),e[14]||(e[14]=k(" 清空购物车 "))]),_:1,__:[14]},8,["disabled"]),a(u,{type:"primary",onClick:ie,disabled:i.value.length===0},{default:n(()=>[a(m,null,{default:n(()=>[a(y(ee))]),_:1}),e[15]||(e[15]=k(" 结算 "))]),_:1,__:[15]},8,["disabled"])])]),s("div",Le,[s("div",Oe,[s("div",He,[e[17]||(e[17]=s("h3",null,"商品列表",-1)),s("div",Qe,[a(G,{modelValue:$.value,"onUpdate:modelValue":e[1]||(e[1]=l=>$.value=l),onChange:q,size:"small"},{default:n(()=>[a(p,{label:null},{default:n(()=>e[16]||(e[16]=[k("全部")])),_:1,__:[16]}),(d(!0),r(S,null,D(F.value,l=>(d(),Ce(p,{key:l.id,label:l.id},{default:n(()=>[k(o(l.name),1)]),_:2},1032,["label"]))),128))]),_:1},8,["modelValue"])])]),fe((d(),r("div",We,[(d(!0),r(S,null,D(b.value,l=>(d(),r("div",{key:l.id,class:"product-card",onClick:J=>j(l)},[s("div",Ye,[l.imageUrl?(d(),r("img",{key:0,src:l.imageUrl,alt:"商品图片",onError:de},null,40,Ze)):(d(),r("div",je,o(l.name.substring(0,2)),1))]),s("div",Ge,[s("div",Je,o(l.name),1),s("div",Re,"¥"+o(l.salePrice.toFixed(2)),1),s("div",es,"库存: "+o(l.currentStock),1)])],8,Xe))),128))])),[[me,E.value]]),w.value>0?(d(),r("div",ss,[a(re,{"current-page":B.value,"onUpdate:currentPage":e[2]||(e[2]=l=>B.value=l),"page-size":M.value,"onUpdate:pageSize":e[3]||(e[3]=l=>M.value=l),"page-sizes":[12,24,36],layout:"total, sizes, prev, pager, next",total:w.value,onSizeChange:q,onCurrentChange:q,background:""},null,8,["current-page","page-size","total"])])):I("",!0)]),s("div",ts,[s("div",ls,[s("h3",null,"购物车 ("+o(i.value.length)+")",1)]),s("div",as,[i.value.length===0?(d(),r("div",os,[a(ce,{description:"购物车为空"})])):I("",!0),(d(!0),r(S,null,D(i.value,(l,J)=>(d(),r("div",{key:l.id,class:"cart-item"},[s("div",ns,[s("div",is,o(l.name),1),s("div",us,"¥"+o(l.salePrice.toFixed(2)),1)]),s("div",ds,[a(O,{modelValue:l.quantity,"onUpdate:modelValue":H=>l.quantity=H,min:1,max:l.currentStock,size:"small",onChange:H=>ae(l)},null,8,["modelValue","onUpdate:modelValue","max","onChange"]),a(u,{type:"danger",size:"small",onClick:H=>oe(J),icon:y(R)},null,8,["onClick","icon"])]),s("div",rs," ¥"+o((l.salePrice*l.quantity).toFixed(2)),1)]))),128))]),s("div",cs,[s("div",vs,[e[18]||(e[18]=s("span",null,"商品数量:",-1)),s("span",null,o(K.value)+" 件",1)]),s("div",ms,[e[19]||(e[19]=s("span",null,"合计:",-1)),s("span",null,"¥"+o(P.value.toFixed(2)),1)])])])]),a(ve,{modelValue:U.value,"onUpdate:modelValue":e[8]||(e[8]=l=>U.value=l),title:"订单结算",width:"600px","close-on-click-modal":!1,"close-on-press-escape":!1},{footer:n(()=>[s("div",Os,[a(u,{onClick:e[7]||(e[7]=l=>U.value=!1),size:"large"},{default:n(()=>e[38]||(e[38]=[k(" 取消 ")])),_:1,__:[38]}),a(u,{type:"primary",onClick:ue,loading:T.value,size:"large"},{default:n(()=>e[39]||(e[39]=[k(" 确认结算 ")])),_:1,__:[39]},8,["loading"])])]),default:n(()=>[s("div",ps,[s("div",_s,[e[25]||(e[25]=s("h4",null,"订单详情",-1)),s("div",gs,[e[20]||(e[20]=s("div",{class:"item-header"},[s("span",{class:"item-name"},"商品名称"),s("span",{class:"item-price"},"单价"),s("span",{class:"item-quantity"},"数量"),s("span",{class:"item-subtotal"},"小计")],-1)),(d(!0),r(S,null,D(i.value,l=>(d(),r("div",{key:l.id,class:"order-item"},[s("span",fs,o(l.name),1),s("span",ys,"¥"+o(l.salePrice.toFixed(2)),1),s("span",hs,o(l.quantity),1),s("span",ks,"¥"+o((l.salePrice*l.quantity).toFixed(2)),1)]))),128))]),s("div",xs,[s("div",Cs,[e[21]||(e[21]=s("span",null,"商品总数:",-1)),s("span",null,o(K.value)+" 件",1)]),s("div",ws,[e[22]||(e[22]=s("span",null,"商品金额:",-1)),s("span",null,"¥"+o(P.value.toFixed(2)),1)]),z.value<100?(d(),r("div",bs,[e[23]||(e[23]=s("span",null,"会员折扣:",-1)),s("span",null,o(z.value)+"% (-¥"+o(W.value.toFixed(2))+")",1)])):I("",!0),s("div",Vs,[e[24]||(e[24]=s("span",null,"应付金额:",-1)),s("span",null,"¥"+o(g.value.toFixed(2)),1)])])]),s("div",zs,[e[28]||(e[28]=s("h4",null,"会员优惠",-1)),s("div",Ps,[a(O,{modelValue:z.value,"onUpdate:modelValue":e[4]||(e[4]=l=>z.value=l),min:0,max:100,precision:1,size:"small",style:{width:"120px"}},null,8,["modelValue"]),e[26]||(e[26]=s("span",{style:{"margin-left":"8px"}},"% 折扣率",-1)),e[27]||(e[27]=s("div",{style:{"margin-top":"8px","font-size":"0.9rem",color:"#909399"}}," 例如：88% = 按原价的88%计算，50% = 半价 ",-1))])]),s("div",qs,[e[33]||(e[33]=s("h4",null,"支付方式",-1)),a(G,{modelValue:h.value,"onUpdate:modelValue":e[5]||(e[5]=l=>h.value=l),size:"large"},{default:n(()=>[a(p,{label:"现金",class:"payment-option"},{default:n(()=>[s("div",Fs,[a(m,null,{default:n(()=>[a(y(ee))]),_:1}),e[29]||(e[29]=s("span",null,"现金支付",-1))])]),_:1}),a(p,{label:"支付宝",class:"payment-option"},{default:n(()=>[s("div",Us,[a(m,null,{default:n(()=>[a(y(se))]),_:1}),e[30]||(e[30]=s("span",null,"支付宝",-1))])]),_:1}),a(p,{label:"微信",class:"payment-option"},{default:n(()=>[s("div",As,[a(m,null,{default:n(()=>[a(y(ke))]),_:1}),e[31]||(e[31]=s("span",null,"微信支付",-1))])]),_:1}),a(p,{label:"银行卡",class:"payment-option"},{default:n(()=>[s("div",Ns,[a(m,null,{default:n(()=>[a(y(se))]),_:1}),e[32]||(e[32]=s("span",null,"银行卡",-1))])]),_:1})]),_:1},8,["modelValue"])]),h.value==="现金"?(d(),r("div",Bs,[e[37]||(e[37]=s("h4",null,"现金支付",-1)),s("div",Is,[s("div",Ss,[e[34]||(e[34]=s("span",null,"应付金额:",-1)),s("span",Ds,"¥"+o(g.value.toFixed(2)),1)]),s("div",Es,[e[35]||(e[35]=s("span",null,"收款金额:",-1)),a(O,{modelValue:V.value,"onUpdate:modelValue":e[6]||(e[6]=l=>V.value=l),min:g.value,precision:2,size:"large",style:{width:"150px"}},null,8,["modelValue","min"])]),L.value>0?(d(),r("div",$s,[e[36]||(e[36]=s("span",null,"找零金额:",-1)),s("span",Ms,"¥"+o(L.value.toFixed(2)),1)])):I("",!0)])])):(d(),r("div",Ts,[s("div",Ks,[a(m,null,{default:n(()=>[a(y(xe))]),_:1}),s("p",null,"请客户使用"+o(h.value)+"扫码支付",1),s("p",Ls,"支付金额: ¥"+o(g.value.toFixed(2)),1)])]))])]),_:1},8,["modelValue"])])}}}),Xs=be(Hs,[["__scopeId","data-v-995216e3"]]);export{Xs as default};
